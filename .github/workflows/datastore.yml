name: Run DataStore Script

on:
  schedule:
    # Trigger at 2:15 AM UTC (7:45 AM IST) Mon-Fri
    - cron: '15 2 * * 1-5'
  workflow_dispatch:
    inputs:
      force_run:
        description: 'Force run (skips wait and day check)'
        required: false
        default: 'false'
        type: boolean

jobs:
  run-datastore:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    timeout-minutes: 180
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Smart Scheduler - Wait until 9:29 AM IST
        run: |
          #!/bin/bash
          if [[ "${{ github.event.inputs.force_run }}" == "true" ]]; then
            echo ">> Manual Force Run detected. Skipping wait logic."
            exit 0
          fi
          TARGET_HOUR=9
          TARGET_MINUTE=29
          TARGET_TOTAL=$((TARGET_HOUR * 60 + TARGET_MINUTE))
          while true; do
            H=$(TZ='Asia/Kolkata' date '+%H')
            M=$(TZ='Asia/Kolkata' date '+%M')
            CURRENT_TOTAL=$(( 10#$H * 60 + 10#$M ))
            CURRENT_TIME=$(TZ='Asia/Kolkata' date '+%H:%M:%S')
            if [ $CURRENT_TOTAL -lt $TARGET_TOTAL ]; then
              DIFF=$((TARGET_TOTAL - CURRENT_TOTAL))
              echo "[Waiting] IST: $CURRENT_TIME. Target: 09:29 ($DIFF mins left...)"
              sleep 60
            else
              echo "[Ready] Target reached at $CURRENT_TIME IST."
              break
            fi
          done

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install yfinance==0.2.52 pandas curl_cffi

      - name: Run DataStore.py
        id: run_script
        run: |
          python DataStore.py
          if [ -d "results_pkl" ] && [ "$(ls -A results_pkl)" ]; then
            echo "data_saved=true" >> $GITHUB_ENV
          else
            echo "data_saved=false" >> $GITHUB_ENV
          fi

      - name: Commit and Push data
        if: env.data_saved == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add results_pkl/*.pkl
          git commit -m "Automated Data Update: $(TZ='Asia/Kolkata' date)"
          git push